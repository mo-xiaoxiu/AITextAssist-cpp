<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠ©æ‰‹ - å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
        }

        .new-chat-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .conversation-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .conversation-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .conversation-time {
            font-size: 12px;
            opacity: 0.7;
            margin-left: 8px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ff4757;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .conversation-item:hover .delete-btn {
            opacity: 1;
        }

        .conversation-item.active .delete-btn {
            color: rgba(255, 255, 255, 0.8);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content code {
            background: #f4f4f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content ul, .message-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .message-content blockquote {
            border-left: 4px solid #007bff;
            padding-left: 16px;
            margin: 10px 0;
            color: #666;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            resize: none;
            min-height: 50px;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: #007bff;
        }

        .send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            min-width: 80px;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 70%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .welcome-message {
            text-align: center;
            color: #666;
            margin-top: 50px;
            font-size: 18px;
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(280px);
            }

            .overlay.show {
                display: block;
            }

            .main-content {
                width: 100%;
            }

            .chat-header {
                padding-left: 60px;
            }

            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">ğŸ’¬ å¯¹è¯å†å²</div>
            <button class="new-chat-btn" onclick="createNewConversation()">æ–°å¯¹è¯</button>
        </div>
        <div class="conversation-list" id="conversationList">
            <!-- å¯¹è¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            ğŸ¤– AIåŠ©æ‰‹ - å¢å¼ºç‰ˆ
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ<br>
                <small>æ”¯æŒMarkdownæ ¼å¼æ˜¾ç¤ºï¼Œå¯ä»¥æŸ¥çœ‹å’Œç®¡ç†å†å²å¯¹è¯</small>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                rows="1"
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        // é…ç½®marked.js
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // å…¨å±€å˜é‡
        let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
        let currentConversationId = null;
        const API_BASE_URL = 'http://localhost:8080';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing application...');

            // ç›´æ¥ä»åç«¯åŠ è½½å¯¹è¯åˆ—è¡¨
            await loadConversationsFromBackend();

            setupEventListeners();

            console.log('Found conversations:', conversations.length);

            // å¦‚æœæœ‰å¯¹è¯ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ª
            if (conversations.length > 0) {
                console.log('Loading first conversation:', conversations[0].id);
                await selectConversation(conversations[0].id);
            }
        });

        // ä»åç«¯åŠ è½½å¯¹è¯åˆ—è¡¨
        async function loadConversationsFromBackend() {
            try {
                console.log('Loading conversations from backend...');
                const response = await fetch(`${API_BASE_URL}/api/conversations`);
                if (response.ok) {
                    const data = await response.json();
                    conversations = (data.conversations || []).map(conv => ({
                        id: conv.id,
                        title: conv.title || 'æ–°å¯¹è¯',
                        createdAt: new Date(conv.created_at * 1000).toISOString(),
                        updatedAt: new Date().toISOString()
                    }));

                    // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
                    conversations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    console.log('Conversations loaded:', conversations.length);
                    renderConversationList();
                } else {
                    console.error('Failed to load conversations:', response.status);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
        function renderConversationList() {
            const conversationList = document.getElementById('conversationList');
            conversationList.innerHTML = '';

            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.dataset.conversationId = conv.id;
                item.onclick = () => selectConversation(conv.id);

                const title = conv.title || 'æ–°å¯¹è¯';
                const time = new Date(conv.createdAt).toLocaleDateString();

                item.innerHTML = `
                    <div class="conversation-title">${title}</div>
                    <div class="conversation-time">${time}</div>
                    <button class="delete-btn" onclick="deleteConversation('${conv.id}', event)">ğŸ—‘ï¸</button>
                `;

                // å¦‚æœæ˜¯å½“å‰å¯¹è¯ï¼Œæ·»åŠ activeç±»
                if (conv.id === currentConversationId) {
                    item.classList.add('active');
                }

                conversationList.appendChild(item);
            });
        }

        // ä»åç«¯åŒæ­¥å¯¹è¯åˆ—è¡¨
        async function syncConversationsFromBackend() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/conversations`);

                if (response.ok) {
                    const data = await response.json();

                    // åˆå¹¶åç«¯å¯¹è¯åˆ°æœ¬åœ°å­˜å‚¨
                    const backendConversations = data.conversations || [];

                    for (const backendConv of backendConversations) {
                        const existingConv = conversations.find(c => c.id === backendConv.id);

                        if (!existingConv) {
                            // æ·»åŠ æ–°çš„å¯¹è¯
                            conversations.push({
                                id: backendConv.id,
                                title: backendConv.title || 'æœªå‘½åå¯¹è¯',
                                messages: [], // æ¶ˆæ¯å°†åœ¨é€‰æ‹©å¯¹è¯æ—¶åŠ è½½
                                createdAt: new Date(backendConv.created_at * 1000).toISOString(),
                                updatedAt: new Date().toISOString()
                            });
                        }
                    }

                    // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
                    conversations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    saveConversations();
                } else {
                    console.error('Failed to sync conversations from backend:', response.status);
                }
            } catch (error) {
                console.error('Error syncing conversations from backend:', error);
            }
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // å›è½¦å‘é€æ¶ˆæ¯
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // åˆ›å»ºæ–°å¯¹è¯
        function createNewConversation() {
            const newConversation = {
                id: 'conv_' + Date.now(),
                title: 'æ–°å¯¹è¯',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            conversations.unshift(newConversation);
            saveConversations();
            loadConversations();
            selectConversation(newConversation.id);
        }

        // åŠ è½½å¯¹è¯åˆ—è¡¨
        function loadConversations() {
            const conversationList = document.getElementById('conversationList');
            conversationList.innerHTML = '';
            
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.dataset.conversationId = conv.id;
                item.onclick = () => selectConversation(conv.id);

                const title = conv.title || 'æ–°å¯¹è¯';
                const time = new Date(conv.updatedAt).toLocaleDateString();

                item.innerHTML = `
                    <div class="conversation-title">${title}</div>
                    <div class="conversation-time">${time}</div>
                    <button class="delete-btn" onclick="deleteConversation('${conv.id}', event)">ğŸ—‘ï¸</button>
                `;

                // å¦‚æœæ˜¯å½“å‰å¯¹è¯ï¼Œæ·»åŠ activeç±»
                if (conv.id === currentConversationId) {
                    item.classList.add('active');
                }

                conversationList.appendChild(item);
            });
        }

        // é€‰æ‹©å¯¹è¯
        async function selectConversation(conversationId) {
            console.log('Selecting conversation:', conversationId);
            currentConversationId = conversationId;

            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });

            const selectedItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }

            // ç›´æ¥ä»åç«¯åŠ è½½æ¶ˆæ¯ï¼Œä¸ä¾èµ–æœ¬åœ°å­˜å‚¨
            await loadMessagesFromBackend(conversationId);

            console.log('Conversation selected, currentConversationId:', currentConversationId);
        }

        // ä»åç«¯åŠ è½½æ¶ˆæ¯
        async function loadMessagesFromBackend(conversationId) {
            try {
                console.log('Loading messages from backend for:', conversationId);
                const response = await fetch(`${API_BASE_URL}/api/conversations/messages?conversation_id=${conversationId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Messages loaded:', data.messages?.length || 0);

                    // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = '';

                    // æ¸²æŸ“æ¶ˆæ¯
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            addMessageToUI(msg.content, msg.role);
                        });
                    }
                } else {
                    console.error('Failed to load messages:', response.status);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // ä»åç«¯åŠ è½½å¯¹è¯å†å²
        async function loadConversationFromBackend(conversationId) {
            console.log('Loading conversation from backend:', conversationId);
            try {
                const response = await fetch(`${API_BASE_URL}/api/conversations/messages?conversation_id=${conversationId}`);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded conversation data:', data);

                    // æ›´æ–°æœ¬åœ°å¯¹è¯æ•°æ®
                    let conversation = conversations.find(c => c.id === conversationId);
                    if (!conversation) {
                        // å¦‚æœæœ¬åœ°æ²¡æœ‰è¿™ä¸ªå¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
                        conversation = {
                            id: conversationId,
                            title: 'å†å²å¯¹è¯',
                            messages: [],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        conversations.unshift(conversation);
                        console.log('Created new conversation entry');
                    }

                    // æ›´æ–°æ¶ˆæ¯å†å²
                    conversation.messages = data.messages.map(msg => ({
                        role: msg.role,
                        content: msg.content,
                        timestamp: new Date(msg.timestamp * 1000).toISOString()
                    }));

                    // å¦‚æœæœ‰æ¶ˆæ¯ï¼Œä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
                    const firstUserMessage = conversation.messages.find(m => m.role === 'user');
                    if (firstUserMessage && conversation.title === 'å†å²å¯¹è¯') {
                        conversation.title = firstUserMessage.content.substring(0, 20) +
                                           (firstUserMessage.content.length > 20 ? '...' : '');
                    }

                    console.log('Updated conversation:', conversation);
                    saveConversations();
                    loadConversations();
                } else {
                    console.error('Failed to load conversation from backend:', response.status);
                }
            } catch (error) {
                console.error('Error loading conversation from backend:', error);
            }
        }

        // åŠ è½½æ¶ˆæ¯
        function loadMessages() {
            const conversation = conversations.find(c => c.id === currentConversationId);
            const chatMessages = document.getElementById('chatMessages');
            
            if (!conversation) return;
            
            chatMessages.innerHTML = '';
            
            if (conversation.messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="welcome-message">
                        ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ<br>
                        <small>æ”¯æŒMarkdownæ ¼å¼æ˜¾ç¤ºï¼Œå¯ä»¥æŸ¥çœ‹å’Œç®¡ç†å†å²å¯¹è¯</small>
                    </div>
                `;
            } else {
                conversation.messages.forEach(message => {
                    addMessageToUI(message.content, message.role, false);
                });
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollTop;
        }

        // åˆ é™¤å¯¹è¯
        function deleteConversation(conversationId, event) {
            event.stopPropagation();
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                conversations = conversations.filter(c => c.id !== conversationId);
                saveConversations();
                loadConversations();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œåˆ‡æ¢åˆ°å…¶ä»–å¯¹è¯æˆ–åˆ›å»ºæ–°å¯¹è¯
                if (currentConversationId === conversationId) {
                    if (conversations.length > 0) {
                        selectConversation(conversations[0].id);
                    } else {
                        createNewConversation();
                    }
                }
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            console.log('Sending message:', message, 'to conversation:', currentConversationId);

            if (!message) {
                console.log('Message is empty');
                return;
            }

            // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯IDï¼Œåˆ›å»ºæ–°å¯¹è¯
            if (!currentConversationId) {
                console.log('No current conversation, will create new one');
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°UI
            addMessageToUI(message, 'user');

            // æ˜¾ç¤ºè¾“å…¥çŠ¶æ€
            showTyping();
            document.getElementById('sendButton').disabled = true;
            
            try {
                // è°ƒç”¨API
                const requestBody = { message: message };
                if (currentConversationId) {
                    requestBody.conversation_id = currentConversationId;
                }

                console.log('Sending request:', requestBody);

                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                console.log('API response:', data);

                // æ›´æ–°conversation_idï¼ˆå¦‚æœåç«¯è¿”å›äº†æ–°çš„IDï¼‰
                if (data.conversation_id && data.conversation_id !== currentConversationId) {
                    console.log('Updating conversation ID from', currentConversationId, 'to', data.conversation_id);
                    currentConversationId = data.conversation_id;

                    // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨ä»¥åŒ…å«æ–°å¯¹è¯
                    await loadConversationsFromBackend();
                }

                // éšè—è¾“å…¥çŠ¶æ€
                hideTyping();

                // æ·»åŠ AIå›å¤åˆ°UI
                const aiResponse = data.response || 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚';
                addMessageToUI(aiResponse, 'assistant');

                // æ³¨é‡Šæ‰æœ¬åœ°æ¶ˆæ¯ä¿å­˜ï¼Œè®©åç«¯æ•°æ®åº“ä½œä¸ºå”¯ä¸€æ•°æ®æº
                // addMessageToConversation(message, 'user');
                // addMessageToConversation(aiResponse, 'assistant');

                // æ›´æ–°å¯¹è¯æ ‡é¢˜
                updateConversationTitle();
                
            } catch (error) {
                console.error('Error:', error);
                hideTyping();
                addMessageToUI('æŠ±æ­‰ï¼Œè¿æ¥æœåŠ¡å™¨æ—¶å‡ºç°é”™è¯¯ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚', 'assistant');
            }
            
            document.getElementById('sendButton').disabled = false;
            chatInput.focus();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°UI
        function addMessageToUI(content, sender, scroll = true) {
            const chatMessages = document.getElementById('chatMessages');
            
            // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (sender === 'assistant') {
                // å¯¹AIå›å¤ä½¿ç”¨Markdownæ¸²æŸ“
                contentDiv.innerHTML = marked.parse(content);
            } else {
                // ç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            if (scroll) {
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯
        function addMessageToConversation(content, role) {
            if (!currentConversationId) {
                console.error('No current conversation ID');
                return;
            }

            let conversation = conversations.find(c => c.id === currentConversationId);

            // å¦‚æœæ‰¾ä¸åˆ°å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
            if (!conversation) {
                console.log('Creating new conversation entry for:', currentConversationId);
                conversation = {
                    id: currentConversationId,
                    title: role === 'user' ? (content.substring(0, 20) + (content.length > 20 ? '...' : '')) : 'æ–°å¯¹è¯',
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                conversations.unshift(conversation);
            }

            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
            const existingMessage = conversation.messages.find(m =>
                m.role === role && m.content === content &&
                Math.abs(new Date() - new Date(m.timestamp)) < 1000 // 1ç§’å†…çš„æ¶ˆæ¯è®¤ä¸ºæ˜¯é‡å¤çš„
            );

            if (!existingMessage) {
                conversation.messages.push({
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString()
                });

                conversation.updatedAt = new Date().toISOString();
                saveConversations();
                loadConversations(); // é‡æ–°åŠ è½½ä»¥æ›´æ–°æ—¶é—´æ˜¾ç¤º
                console.log('Added message to conversation:', role, content.substring(0, 50));
            } else {
                console.log('Message already exists, skipping duplicate');
            }
        }

        // æ›´æ–°å¯¹è¯æ ‡é¢˜
        function updateConversationTitle() {
            const conversation = conversations.find(c => c.id === currentConversationId);
            if (!conversation || conversation.messages.length === 0) return;
            
            // ä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
            const firstUserMessage = conversation.messages.find(m => m.role === 'user');
            if (firstUserMessage && conversation.title === 'æ–°å¯¹è¯') {
                conversation.title = firstUserMessage.content.substring(0, 20) + (firstUserMessage.content.length > 20 ? '...' : '');
                saveConversations();
                loadConversations();
            }
        }

        // æ˜¾ç¤ºè¾“å…¥çŠ¶æ€
        function showTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            const chatMessages = document.getElementById('chatMessages');
            
            typingIndicator.style.display = 'block';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // éšè—è¾“å…¥çŠ¶æ€
        function hideTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'none';
        }

        // ä¿å­˜å¯¹è¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveConversations() {
            localStorage.setItem('conversations', JSON.stringify(conversations));
        }

        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }
    </script>
</body>
</html>
